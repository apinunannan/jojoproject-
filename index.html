<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order Bill</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Sarabun',sans-serif;background:#f8fafc;min-height:100vh}
  #app{max-width:640px;margin:0 auto;padding-bottom:40px}

  /* Header */
  .header{background:#1e293b;color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10}
  .header-title{font-size:17px;font-weight:700}
  .header-sub{font-size:11px;color:#94a3b8}
  .header-name{font-size:12px;color:#93c5fd}

  /* Buttons */
  .btn-primary{background:#3b82f6;color:#fff;border:none;border-radius:8px;padding:8px 18px;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer}
  .btn-primary:hover{background:#2563eb}
  .btn-secondary{background:transparent;color:#475569;border:1px solid #e2e8f0;border-radius:8px;padding:7px 12px;font-family:inherit;font-size:13px;cursor:pointer}
  .btn-secondary:hover{background:#f8fafc}
  .btn-back{background:none;border:none;color:#94a3b8;font-family:inherit;font-size:22px;cursor:pointer;padding:0 4px;line-height:1}
  .btn-danger{color:#ef4444;border-color:#fecaca}
  .btn-add{background:#eff6ff;color:#3b82f6;border:none;border-radius:8px;padding:5px 12px;font-family:inherit;font-size:12px;cursor:pointer;font-weight:600}

  /* Toast */
  .toast{position:fixed;top:66px;left:50%;transform:translateX(-50%);background:#10b981;color:#fff;padding:9px 22px;border-radius:24px;font-size:13px;z-index:100;box-shadow:0 4px 20px rgba(0,0,0,.2);pointer-events:none;opacity:0;transition:opacity .3s}
  .toast.show{opacity:1}

  /* Toolbar */
  .toolbar{padding:12px 16px 8px}
  .search-wrap{display:flex;align-items:center;background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:0 14px}
  .search-icon{font-size:14px;margin-right:6px;color:#94a3b8}
  .search-input{flex:1;border:none;outline:none;font-family:inherit;font-size:14px;padding:11px 8px;background:transparent}
  .search-clear{cursor:pointer;color:#94a3b8;font-size:16px;background:none;border:none;font-family:inherit}

  /* List */
  .list{display:flex;flex-direction:column;gap:8px;padding:0 16px}
  .list-count{padding:4px 0 6px;font-size:12px;color:#94a3b8}
  .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 1px 3px rgba(0,0,0,.04);cursor:pointer;border:1px solid #f1f5f9;transition:box-shadow .15s}
  .card:hover{box-shadow:0 4px 12px rgba(0,0,0,.08)}
  .card-inner{display:flex;gap:12px;align-items:center}
  .card-thumb{width:62px;height:62px;object-fit:cover;border-radius:8px;flex-shrink:0}
  .card-thumb-placeholder{width:62px;height:62px;background:#f1f5f9;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0}
  .card-body{flex:1;min-width:0}
  .card-id{font-size:11px;color:#94a3b8}
  .card-name{font-size:16px;font-weight:700;color:#1e293b;margin:2px 0}
  .card-job{font-size:12px;color:#3b82f6;font-weight:600;margin-bottom:1px}
  .card-meta{display:flex;flex-wrap:wrap;gap:2px 10px;font-size:12px;color:#64748b}
  .card-fabric{font-size:12px;color:#94a3b8;margin-top:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .card-arrow{color:#cbd5e1;font-size:20px;flex-shrink:0}

  /* Empty */
  .empty{text-align:center;padding:60px 20px;display:flex;flex-direction:column;align-items:center;gap:12px;color:#94a3b8}
  .empty-icon{font-size:48px}

  /* Form */
  .form-body{padding:16px}
  .section{background:#fff;border-radius:12px;padding:16px;margin-bottom:10px;border:1px solid #f1f5f9}
  .section-title{font-weight:700;color:#1e293b;font-size:14px}
  .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .field{display:flex;flex-direction:column;gap:4px}
  .label{font-size:12px;color:#64748b;font-weight:600}
  .input{border:1px solid #e2e8f0;border-radius:8px;padding:10px 12px;font-family:inherit;font-size:14px;outline:none;color:#1e293b;background:#fff;width:100%}
  .input:focus{border-color:#93c5fd}
  textarea.input{resize:none}

  /* Images */
  .img-upload-box{border:2px dashed #e2e8f0;border-radius:10px;padding:30px;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;background:#f8fafc}
  .img-upload-box:hover{border-color:#93c5fd;background:#eff6ff}
  .img-upload-icon{font-size:36px}
  .img-upload-text{font-size:13px;color:#94a3b8}
  .img-grid{display:grid;gap:8px}
  .img-wrap{position:relative}
  .img-preview{width:100%;aspect-ratio:16/9;object-fit:contain;border-radius:8px;display:block;background:#f1f5f9}
  .img-remove{position:absolute;top:6px;right:6px;background:rgba(0,0,0,.5);color:#fff;border:none;border-radius:50%;width:26px;height:26px;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;font-family:inherit}

  /* Size table */
  .size-table{width:100%;border-collapse:collapse;font-size:13px}
  .size-table th{padding:5px 8px;font-weight:600;color:#64748b;font-size:11px;background:#f1f5f9}
  .size-table th:first-child{text-align:left;border-radius:6px 0 0 6px}
  .size-table th:last-child{border-radius:0 6px 6px 0;width:24px}
  .size-table th.center{text-align:center}
  .size-table td{padding:4px 6px;border-bottom:1px solid #f1f5f9}
  .size-table td.center{text-align:center}
  .size-name-input{border:1px solid #e2e8f0;border-radius:6px;padding:4px 6px;font-size:12px;font-weight:700;width:64px;outline:none;font-family:inherit;background:#fff}
  .size-qty-input{border:1px solid #e2e8f0;border-radius:6px;padding:4px 6px;font-size:13px;font-weight:700;width:64px;text-align:center;outline:none;font-family:inherit;background:#fff}
  .size-remove{background:none;border:none;color:#cbd5e1;cursor:pointer;font-size:12px;padding:0}
  .tfoot-total td{padding:6px 8px;background:#eff6ff;font-weight:700;color:#1d4ed8}
  .tfoot-grand td{padding:5px 8px;background:#dbeafe;text-align:center;font-weight:800;color:#1e40af;font-size:13px}

  /* Detail */
  .detail-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .detail-2col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .detail-label{font-size:11px;color:#94a3b8;margin-bottom:2px}
  .detail-val{font-weight:700;color:#1e293b;font-size:15px}
  .detail-val.blue{color:#3b82f6}
  .detail-sep{margin-top:10px;padding-top:10px;border-top:1px solid #f1f5f9}
  .pre-wrap{white-space:pre-wrap;line-height:1.7;font-size:14px;color:#334155}
  .pre-wrap.amber{color:#92400e}
  .pre-wrap.sm{font-size:13px}

  .detail-size-table{width:100%;border-collapse:collapse;font-size:13px}
  .detail-size-table th{padding:5px 8px;font-weight:600;color:#64748b;font-size:11px;background:#f1f5f9}
  .detail-size-table th:first-child{text-align:left}
  .detail-size-table th.center{text-align:center}
  .detail-size-table td{padding:4px 8px;border-bottom:1px solid #f1f5f9}
  .detail-size-table td.center{text-align:center;font-weight:800;color:#1d4ed8}
  .detail-size-table td.muted{text-align:center;color:#64748b}

  /* Print */
  @media print{
    .no-print{display:none!important}
    body{background:white;font-size:11px}
    #app{max-width:100%;padding:0}
    .form-body{padding:8px}
    .section{box-shadow:none;border:1px solid #e2e8f0;padding:8px;margin-bottom:6px;border-radius:6px}
    .section-title{font-size:12px}
    .detail-grid{grid-template-columns:repeat(3,1fr);gap:6px}
    .detail-val{font-size:13px}
    .detail-label{font-size:10px}
    .img-grid{margin-bottom:6px}
    .img-preview{aspect-ratio:16/9;object-fit:contain;max-height:180px}
    .img-grid > div, .img-grid img{max-height:180px}
    .pre-wrap{font-size:11px;line-height:1.5}
    .detail-size-table td,.detail-size-table th{padding:3px 6px;font-size:11px}
    .detail-2col{gap:8px}
    @page{size:A4 portrait;margin:12mm 12mm 12mm 12mm}
    .print-only-header{display:block!important}
  }

  /* Responsive */
  @media(max-width:480px){
    .row2{grid-template-columns:1fr}
    .detail-grid{grid-template-columns:1fr 1fr}
  }
</style>
</head>
<body>
<div id="app"></div>

<script>
// ‚îÄ‚îÄ Data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEFAULT_SIZES = ["0","1","2","3","4","5","6","7","9(S)","10(M)","2XL"];
const STORAGE_KEY = "order_bill_v1";

function loadOrders(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]"); }catch{ return []; }
}
function saveOrders(orders){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(orders));
}
function newOrder(){
  return {
    id:"ORD-"+Date.now().toString().slice(-6),
    customerName:"", jobName:"",
    orderDate:new Date().toISOString().split("T")[0], dueDate:"",
    fabricText:"", pattern:"", jobDetail:"", assignee:"",
    sizeNames:[...DEFAULT_SIZES], sizeQty:{}, sizeExtra:{},
    notes:"", images:[]
  };
}
function formatDate(d){
  if(!d)return"-";
  const [y,m,day]=d.split("-");
  const M=["","‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
  return `${parseInt(day)} ${M[parseInt(m)]} ${parseInt(y)+543}`;
}
function totalQty(obj){ return Object.values(obj||{}).reduce((s,v)=>s+(parseInt(v)||0),0); }

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let state = {
  view:"list", // list | form | detail
  orders: loadOrders(),
  current: null,
  search: "",
  toastTimer: null
};

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg; t.classList.add("show");
  clearTimeout(state.toastTimer);
  state.toastTimer=setTimeout(()=>t.classList.remove("show"),2200);
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render(){
  const app=document.getElementById("app");
  if(state.view==="list") app.innerHTML=renderList();
  else if(state.view==="form") app.innerHTML=renderForm();
  else if(state.view==="detail") app.innerHTML=renderDetail();
  bindEvents();
}

// ‚îÄ‚îÄ LIST VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderList(){
  const q=state.search.toLowerCase();
  const filtered=state.orders.filter(o=>
    !q||o.customerName.toLowerCase().includes(q)||o.id.toLowerCase().includes(q)
  );
  let cards="";
  if(filtered.length===0){
    cards=`<div class="empty">
      <div class="empty-icon">${state.search?"üîç":"üìã"}</div>
      <div>${state.search?"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤":"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå"}</div>
      ${!state.search?`<button class="btn-primary" onclick="openNew()">‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡πÅ‡∏£‡∏Å</button>`:""}
    </div>`;
  } else {
    cards=`<div class="list">
      <div class="list-count">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${filtered.length} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
      ${filtered.map(o=>{
        const total=totalQty(o.sizeQty);
        const thumb=o.images&&o.images.length>0
          ?`<img src="${o.images[0]}" class="card-thumb" alt="">`
          :`<div class="card-thumb-placeholder">üëñ</div>`;
        return `<div class="card" onclick="openDetail('${o.id}')">
          <div class="card-inner">
            ${thumb}
            <div class="card-body">
              <div class="card-id">${o.id}</div>
              <div class="card-name">${o.customerName||"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠"}</div>
              ${o.jobName?`<div class="card-job">${o.jobName}</div>`:""}
              <div class="card-meta">
                ${o.orderDate?`<span>üìÖ ${formatDate(o.orderDate)}</span>`:""}
                ${o.dueDate?`<span>üöö ${formatDate(o.dueDate)}</span>`:""}
                ${total>0?`<span>üëñ ${total} ‡∏ï‡∏±‡∏ß</span>`:""}
              </div>
              ${o.fabricText?`<div class="card-fabric">${o.fabricText.split("\n")[0]}</div>`:""}
            </div>
            <div class="card-arrow">‚Ä∫</div>
          </div>
        </div>`;
      }).join("")}
    </div>`;
  }
  return `
    <div class="header">
      <div class="header-title">üßæ Order Bill</div>
      <button class="btn-primary" onclick="openNew()">+ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡∏°‡πà</button>
    </div>
    <div class="toolbar">
      <div class="search-wrap">
        <span class="search-icon">üîç</span>
        <input class="search-input" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå..." value="${escHtml(state.search)}" oninput="onSearch(this.value)">
        ${state.search?`<button class="search-clear" onclick="clearSearch()">‚úï</button>`:""}
      </div>
    </div>
    ${cards}`;
}

// ‚îÄ‚îÄ FORM VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderForm(){
  const o=state.current;
  const isNew=!state.orders.find(x=>x.id===o.id);
  const imgGrid=o.images&&o.images.length>0?
    `<div class="img-grid" style="grid-template-columns:repeat(${Math.min(o.images.length+(o.images.length<3?1:0),3)},1fr)">
      ${o.images.map((img,i)=>`
        <div class="img-wrap">
          <img src="${img}" class="img-preview" alt="">
          <button class="img-remove" onclick="removeImage(${i})">‚úï</button>
        </div>`).join("")}
      ${o.images.length<3?`<div class="img-upload-box" onclick="document.getElementById('img-file').click()" style="padding:16px">
        <div style="font-size:24px">üì∑</div>
        <div style="font-size:11px;color:#94a3b8">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ</div>
      </div>`:""}
    </div>`
    :`<div class="img-upload-box" onclick="document.getElementById('img-file').click()">
      <div class="img-upload-icon">üì∑</div>
      <div class="img-upload-text">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏£‡∏π‡∏õ)</div>
    </div>`;

  // Size rows
  const sizeRows=o.sizeNames.map((name,i)=>`
    <tr>
      <td><input class="size-name-input" value="${escHtml(name)}" oninput="setSizeName(${i},this.value)" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0"></td>
      <td class="center"><input class="size-qty-input" type="number" min="0" value="${o.sizeQty[name]||""}" oninput="setSizeQty('${escHtml(name)}',this.value,${i})" placeholder="0"></td>
      <td class="center"><input class="size-qty-input" type="number" min="0" value="${(o.sizeExtra||{})[name]||""}" oninput="setSizeExtra('${escHtml(name)}',this.value)" placeholder="0"></td>
      <td class="center"><button class="size-remove" onclick="removeSize(${i})">‚úï</button></td>
    </tr>`).join("");
  const total=totalQty(o.sizeQty);
  const totalExtra=totalQty(o.sizeExtra);
  const grandTotal=total+totalExtra;

  return `
    <div class="header">
      <div style="display:flex;align-items:center;gap:10px">
        <button class="btn-back" onclick="goList()">‚Üê</button>
        <div class="header-title">${isNew?"‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡∏°‡πà":"‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå"}</div>
      </div>
      <button class="btn-primary" onclick="saveForm()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚úì</button>
    </div>
    <div class="form-body">

      <div class="section">
        <div class="section-title" style="margin-bottom:12px">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
        <div class="row2">
          <div class="field">
            <label class="label">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ *</label>
            <input class="input" id="f-customerName" value="${escHtml(o.customerName)}" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏¥‡∏£">
          </div>
          <div class="field">
            <label class="label">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label>
            <input class="input" id="f-jobName" value="${escHtml(o.jobName||"")}" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏£‡∏∏‡πà‡∏ô A">
          </div>
        </div>
        <div class="row2" style="margin-top:10px">
          <div class="field">
            <label class="label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á</label>
            <input class="input" type="date" id="f-orderDate" value="${o.orderDate||""}">
          </div>
          <div class="field">
            <label class="label">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</label>
            <input class="input" type="date" id="f-dueDate" value="${o.dueDate||""}">
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <div class="section-title">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
          ${o.images&&o.images.length>0&&o.images.length<3?`<button class="btn-add" onclick="document.getElementById('img-file').click()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ</button>`:""}
        </div>
        <input type="file" id="img-file" accept="image/*" style="display:none" onchange="addImage(this)">
        ${imgGrid}
      </div>

      <div class="section">
        <div class="field">
          <label class="label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</label>
          <textarea class="input" id="f-jobDetail" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô&#10;- ‡πÄ‡∏£‡∏≤‡∏ï‡∏±‡∏î&#10;- ‡πÄ‡∏£‡∏≤‡πÄ‡∏¢‡πá‡∏ö&#10;- ‡∏•‡∏≤‡∏¢‡∏õ‡∏±‡∏Å...">${escHtml(o.jobDetail||"")}</textarea>
        </div>
      </div>

      <div class="section">
        <div class="row2">
          <div class="field">
            <label class="label">‡∏ú‡πâ‡∏≤ / ‡∏™‡∏µ</label>
            <textarea class="input" id="f-fabricText" rows="4" placeholder="‡∏™‡∏µ‡∏Å‡∏£‡∏°&#10;‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏Ç‡πâ‡∏° 1 ‡∏°‡πâ‡∏ß‡∏ô&#10;‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß 1 ‡∏°‡πâ‡∏ß‡∏ô">${escHtml(o.fabricText||"")}</textarea>
          </div>
          <div class="field">
            <label class="label">‡πÅ‡∏û‡∏ó‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô</label>
            <input class="input" id="f-pattern" value="${escHtml(o.pattern||"")}" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏û‡∏ó‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô A">
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <div class="section-title">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÑ‡∏ã‡∏™‡πå</div>
          <button class="btn-add" onclick="addSize()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ã‡∏™‡πå</button>
        </div>
        <table class="size-table">
          <thead><tr>
            <th>Size</th>
            <th class="center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ï‡∏±‡∏ß)</th>
            <th class="center">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</th>
            <th></th>
          </tr></thead>
          <tbody id="size-tbody">${sizeRows}</tbody>
          <tfoot>
            <tr class="tfoot-total">
              <td style="padding:6px 8px;font-size:13px">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</td>
              <td class="center" style="font-size:15px">${total||"-"}</td>
              <td class="center" style="font-size:15px">${totalExtra||"-"}</td>
              <td></td>
            </tr>
            ${grandTotal>0?`<tr class="tfoot-grand"><td colspan="4">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${grandTotal} ‡∏ï‡∏±‡∏ß</td></tr>`:""}
          </tfoot>
        </table>
      </div>

      <div class="section">
        <div class="row2">
          <div class="field">
            <label class="label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            <textarea class="input" id="f-notes" rows="4" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°...">${escHtml(o.notes||"")}</textarea>
          </div>
          <div class="field">
            <label class="label">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏á‡∏≤‡∏ô</label>
            <textarea class="input" id="f-assignee" rows="4" placeholder="‡πÄ‡∏ä‡πà‡∏ô&#10;‡∏ä‡πà‡∏≤‡∏áA&#10;‡∏ä‡πà‡∏≤‡∏áB">${escHtml(o.assignee||"")}</textarea>
          </div>
        </div>
      </div>

    </div>`;
}

// ‚îÄ‚îÄ DETAIL VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDetail(){
  const o=state.current;
  const total=totalQty(o.sizeQty);
  const sizeEntries=(o.sizeNames||[]).map(n=>[n,o.sizeQty?.[n]||""]).filter(([,v])=>parseInt(v)>0);
  const extraTotal=(o.sizeNames||[]).reduce((s,n)=>s+(parseInt((o.sizeExtra||{})[n])||0),0);

  const imgs=o.images&&o.images.length>0
    ?`<div class="img-grid" style="grid-template-columns:repeat(${Math.min(o.images.length,3)},1fr);gap:8px;margin-bottom:12px">
        ${o.images.map(img=>`<img src="${img}" class="img-preview" alt="">`).join("")}
      </div>`:""

  const sizeRows=sizeEntries.map(([name,qty])=>`
    <tr>
      <td style="padding:4px 8px;font-weight:700;color:#334155">${name}</td>
      <td class="center">${qty}</td>
      <td class="muted">${(o.sizeExtra||{})[name]||"-"}</td>
    </tr>`).join("");

  return `
    <style>@media print{.no-print{display:none!important}}</style>
    <div class="print-only-header" style="display:none">
      <div style="padding:8px 12px;border-bottom:2px solid #1e293b;margin-bottom:8px">
        <div style="font-size:10px;color:#94a3b8">${o.id}</div>
        <div style="font-size:18px;font-weight:800;color:#1e293b">${escHtml(o.customerName||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠')}</div>
        ${o.jobName?`<div style="font-size:13px;color:#3b82f6;font-weight:600">${escHtml(o.jobName)}</div>`:''}
      </div>
    </div>
    <div class="header no-print">
      <div style="display:flex;align-items:center;gap:10px">
        <button class="btn-back" onclick="goList()">‚Üê</button>
        <div>
          <div class="header-sub">${o.id}</div>
          <div class="header-title">${escHtml(o.customerName||"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠")}</div>
          ${o.jobName?`<div class="header-name">${escHtml(o.jobName)}</div>`:""}
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn-secondary" onclick="openEdit('${o.id}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button class="btn-secondary btn-danger" onclick="deleteOrder('${o.id}')">üóë</button>
        <button class="btn-secondary" onclick="window.print()">üñ®Ô∏è ‡∏õ‡∏£‡∏¥‡πâ‡∏ô</button>
      </div>
    </div>
    <div class="form-body">

      ${imgs}

      <div class="section">
        <div class="detail-grid">
          <div><div class="detail-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á</div><div class="detail-val">${formatDate(o.orderDate)}</div></div>
          <div><div class="detail-label">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</div><div class="detail-val">${formatDate(o.dueDate)}</div></div>
          <div><div class="detail-label">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="detail-val">${total>0?total+" ‡∏ï‡∏±‡∏ß":"-"}</div></div>
        </div>
        ${o.jobName?`<div class="detail-sep"><div class="detail-label">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</div><div class="detail-val blue">${escHtml(o.jobName)}</div></div>`:""}
      </div>

      ${o.jobDetail?`<div class="section">
        <div class="section-title" style="margin-bottom:10px">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</div>
        <div class="pre-wrap">${escHtml(o.jobDetail)}</div>
      </div>`:""}

      ${o.fabricText||o.pattern?`<div class="section">
        <div class="detail-2col">
          ${o.fabricText?`<div><div class="detail-label">‡∏ú‡πâ‡∏≤ / ‡∏™‡∏µ</div><div class="pre-wrap" style="margin-top:4px">${escHtml(o.fabricText)}</div></div>`:""}
          ${o.pattern?`<div><div class="detail-label">‡πÅ‡∏û‡∏ó‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô</div><div style="color:#334155;font-size:14px;margin-top:4px">${escHtml(o.pattern)}</div></div>`:""}
        </div>
      </div>`:""}

      ${sizeEntries.length>0?`<div class="section">
        <div class="section-header">
          <div class="section-title">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÑ‡∏ã‡∏™‡πå</div>
          <div style="font-size:12px;color:#3b82f6;font-weight:600">‡∏£‡∏ß‡∏° ${total} ‡∏ï‡∏±‡∏ß</div>
        </div>
        <table class="detail-size-table">
          <thead><tr>
            <th>Size</th>
            <th class="center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
            <th class="center">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</th>
          </tr></thead>
          <tbody>${sizeRows}</tbody>
          <tfoot>
            <tr class="tfoot-total">
              <td style="padding:6px 8px">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</td>
              <td class="center" style="padding:6px 8px;font-size:15px">${total}</td>
              <td class="center" style="padding:6px 8px;font-size:15px">${extraTotal||"-"}</td>
            </tr>
            ${total+extraTotal>0?`<tr class="tfoot-grand"><td colspan="3">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total+extraTotal} ‡∏ï‡∏±‡∏ß</td></tr>`:""}
          </tfoot>
        </table>
      </div>`:""}

      ${o.notes||o.assignee?`<div class="section">
        <div class="detail-2col">
          ${o.notes?`<div><div class="detail-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div><div class="pre-wrap amber sm" style="margin-top:4px">${escHtml(o.notes)}</div></div>`:""}
          ${o.assignee?`<div><div class="detail-label">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏á‡∏≤‡∏ô</div><div class="pre-wrap sm" style="margin-top:4px">üë§ ${escHtml(o.assignee)}</div></div>`:""}
        </div>
      </div>`:""}

    </div>`;
}

// ‚îÄ‚îÄ Event Handlers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function bindEvents(){}

function escHtml(s){
  return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

function goList(){ state.view="list"; render(); }
function openNew(){ state.current=newOrder(); state.view="form"; render(); }
function openDetail(id){ state.current=state.orders.find(o=>o.id===id); state.view="detail"; render(); }
function openEdit(id){ state.current={...state.orders.find(o=>o.id===id)}; state.view="form"; render(); }

function onSearch(v){ state.search=v; render(); document.getElementById("search-input")?.focus(); }
function clearSearch(){ state.search=""; render(); }

function collectForm(){
  const o=state.current;
  o.customerName=document.getElementById("f-customerName").value;
  o.jobName=document.getElementById("f-jobName").value;
  o.orderDate=document.getElementById("f-orderDate").value;
  o.dueDate=document.getElementById("f-dueDate").value;
  o.jobDetail=document.getElementById("f-jobDetail").value;
  o.fabricText=document.getElementById("f-fabricText").value;
  o.pattern=document.getElementById("f-pattern").value;
  o.notes=document.getElementById("f-notes").value;
  o.assignee=document.getElementById("f-assignee").value;
}

function saveForm(){
  collectForm();
  const o=state.current;
  if(!o.customerName.trim()){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"); return; }
  const idx=state.orders.findIndex(x=>x.id===o.id);
  if(idx>=0) state.orders[idx]=o;
  else state.orders.unshift(o);
  saveOrders(state.orders);
  showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úì");
  state.view="list"; render();
}

function deleteOrder(id){
  if(!confirm("‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ?")) return;
  state.orders=state.orders.filter(o=>o.id!==id);
  saveOrders(state.orders);
  showToast("‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
  state.view="list"; render();
}

function setSizeName(i,v){
  collectForm();
  const oldName=state.current.sizeNames[i];
  state.current.sizeNames[i]=v;
  // migrate qty/extra to new name
  if(state.current.sizeQty[oldName]!==undefined){
    state.current.sizeQty[v]=state.current.sizeQty[oldName];
    delete state.current.sizeQty[oldName];
  }
  if((state.current.sizeExtra||{})[oldName]!==undefined){
    state.current.sizeExtra[v]=state.current.sizeExtra[oldName];
    delete state.current.sizeExtra[oldName];
  }
  render();
}
function setSizeQty(name,v,i){
  collectForm();
  const curName=state.current.sizeNames[i];
  state.current.sizeQty[curName]=v;
  // update tfoot live without full re-render
  updateSizeTotals();
}
function setSizeExtra(name,v){
  collectForm();
  if(!state.current.sizeExtra) state.current.sizeExtra={};
  state.current.sizeExtra[name]=v;
  updateSizeTotals();
}
function updateSizeTotals(){
  const total=totalQty(state.current.sizeQty);
  const extra=totalQty(state.current.sizeExtra);
  const grand=total+extra;
  const tfoot=document.querySelector(".size-table tfoot");
  if(tfoot) tfoot.innerHTML=`
    <tr class="tfoot-total">
      <td style="padding:6px 8px;font-size:13px">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</td>
      <td class="center" style="font-size:15px">${total||"-"}</td>
      <td class="center" style="font-size:15px">${extra||"-"}</td>
      <td></td>
    </tr>
    ${grand>0?`<tr class="tfoot-grand"><td colspan="4">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${grand} ‡∏ï‡∏±‡∏ß</td></tr>`:""}`;
}
function addSize(){
  collectForm();
  state.current.sizeNames.push("");
  render();
}
function removeSize(i){
  collectForm();
  const name=state.current.sizeNames[i];
  state.current.sizeNames.splice(i,1);
  delete state.current.sizeQty[name];
  if(state.current.sizeExtra) delete state.current.sizeExtra[name];
  render();
}

function addImage(input){
  const file=input.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    collectForm();
    if(!state.current.images) state.current.images=[];
    if(state.current.images.length<3) state.current.images.push(ev.target.result);
    input.value="";
    render();
  };
  reader.readAsDataURL(file);
}
function removeImage(i){
  collectForm();
  state.current.images.splice(i,1);
  render();
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.body.insertAdjacentHTML("beforeend",`<div id="toast" class="toast"></div>`);
render();
</script>
</body>
</html>
